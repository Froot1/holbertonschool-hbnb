<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Place Details</title>
  <link rel="stylesheet" href="styles.css"/>
</head>
<body>
  <div id="header-placeholder"></div>

  <main>
    <section id="place-details">
      <!-- Place details will be populated dynamically -->
    </section>
    <section id="reviews">
      <!-- Reviews will be populated dynamically -->
    </section>
    <section id="add-review">
      <h2>Add a Review</h2>
      <form id="review-form" action="javascript:void(0);">
        <label for="review-text">Review:</label>
        <textarea id="review-text" name="review-text" required></textarea>
        <button type="submit">Submit</button>
      </form>
    </section>
  </main>

  <div id="footer-placeholder"></div>

  <script>
    function getCookie(name) {
      const cookieArr = document.cookie.split(';');
      for (let cookie of cookieArr) {
        cookie = cookie.trim();
        if (cookie.startsWith(name + '=')) {
          return cookie.substring(name.length + 1);
        }
      }
      return null;
    }
  
    function getPlaceIdFromURL() {
      const params = new URLSearchParams(window.location.search);
      return params.get('id');
    }
  
    function getUserIdFromToken(token) {
      try {
        return JSON.parse(atob(token.split('.')[1])).sub;
      } catch (e) {
        console.error('Failed to decode token:', e);
        return null;
      }
    }
  
    function checkAuthentication(token, placeId) {
      const addReviewSection = document.getElementById('add-review');
      if (!token) {
        addReviewSection.style.display = 'none';
      } else {
        addReviewSection.style.display = 'block';
        fetchPlaceDetails(token, placeId);
      }
    }
  
    async function fetchPlaceDetails(token, placeId) {
      try {
        const response = await fetch(`http://localhost:5000/api/v1/places/${placeId}`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
  
        if (!response.ok) throw new Error('Failed to fetch place details');
  
        const place = await response.json();
        displayPlaceDetails(place);
      } catch (error) {
        console.error('Error fetching place details:', error);
      }
    }
  
    function displayPlaceDetails(place) {
      const detailsSection = document.getElementById('place-details');
      detailsSection.innerHTML = `
        <h2>${place.title}</h2>
        <p>${place.description}</p>
        <p><strong>Price:</strong> $${place.price}/night</p>
        <p><strong>Owner:</strong> ${place.owner?.first_name || ''} ${place.owner?.last_name || ''}</p>
        <h3>Amenities:</h3>
        <ul>
          ${place.amenities?.map(a => `<li>${a.name}</li>`).join('') || '<li>None</li>'}
        </ul>
        <h3>Reviews:</h3>
        <ul>
          ${place.reviews?.map(r => `<li><strong>User:</strong> ${r.user_id} | Rating: ${r.rating}<br>${r.text}</li>`).join('') || '<li>No reviews yet.</li>'}
        </ul>
      `;
    }
  
    document.addEventListener('DOMContentLoaded', () => {
      const token = getCookie('token'); // âœ… Declare once here
      const placeId = getPlaceIdFromURL();
      const userId = getUserIdFromToken(token);
  
      checkAuthentication(token, placeId);
  
      const reviewForm = document.getElementById('review-form');
      if (reviewForm && token && placeId && userId) {
        reviewForm.addEventListener('submit', async (event) => {
          event.preventDefault();
          const reviewText = document.getElementById('review-text').value;
  
          try {
            const response = await fetch('http://localhost:5000/api/v1/reviews/', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
              },
              body: JSON.stringify({
                text: reviewText,
                rating: 5,
                place_id: placeId,
                user_id: userId
              })
            });
  
            if (response.ok) {
              alert('Review submitted successfully!');
              reviewForm.reset();
              fetchPlaceDetails(token, placeId);
            } else {
              const errorData = await response.json();
              alert(`Error submitting review: ${errorData.error || response.statusText}`);
            }
          } catch (err) {
            console.error('Error submitting review:', err);
            alert('Failed to submit review');
          }
        });
      }
    });
  </script>
  